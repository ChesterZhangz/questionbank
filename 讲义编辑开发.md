# 讲义编辑功能开发计划

## 1. 功能概述

### 1.1 核心功能（参考Vditor设计）
- **多模式编辑器**：支持所见即所得（WYSIWYG）、即时渲染（IR，类似Typora）、分屏预览（SV）三种模式
- **题目插入**：支持从题库中拖拽题目到讲义中
- **LaTeX渲染**：实时数学公式渲染（使用KaTeX）
- **图片管理**：支持图片上传、定位、调整
- **PDF导出**：生成与LaTeX渲染效果一致的PDF
- **多媒体支持**：流程图、时序图、甘特图、脑图等

### 1.2 用户交互流程
1. 用户创建/编辑讲义
2. 在A4纸张模拟界面中直接输入内容
3. 实时看到Markdown渲染效果
4. 可以插入题目、图片等元素
5. 导出为PDF格式

## 2. 技术架构

### 2.1 前端技术栈（参考Vditor技术选型）
- **React + TypeScript**：主要开发框架
- **Tailwind CSS**：样式管理
- **KaTeX**：LaTeX数学公式渲染
- **Framer Motion**：动画效果
- **React DnD**：拖拽功能
- **Lute引擎**：Markdown解析引擎（Vditor核心）
- **highlight.js**：代码高亮
- **mermaid**：流程图渲染
- **echarts**：图表渲染

### 2.2 核心组件架构（参考Vditor模块化设计）
```
LectureEditor/
├── core/
│   ├── LectureEditor.tsx          # 主编辑器组件（类似Vditor的Vditor类）
│   ├── ContentRenderer.tsx        # 内容渲染器（类似Vditor的preview模块）
│   ├── CursorManager.tsx          # 光标管理（类似Vditor的cursor模块）
│   └── ModeManager.tsx            # 模式管理器（WYSIWYG/IR/SV切换）
├── components/
│   ├── QuestionInserter.tsx       # 题目插入组件
│   ├── ImageManager.tsx           # 图片管理组件
│   ├── Toolbar.tsx                # 工具栏（参考Vditor的toolbar模块）
│   ├── PDFPreview.tsx             # PDF预览
│   └── MediaRenderer.tsx          # 多媒体渲染器
├── hooks/
│   ├── useLectureEditor.ts        # 编辑器状态管理
│   ├── useQuestionInsert.ts       # 题目插入逻辑
│   ├── usePDFExport.ts            # PDF导出逻辑
│   └── useModeSwitch.ts           # 模式切换逻辑
├── utils/
│   ├── markdownParser.ts          # Markdown解析（使用Lute引擎）
│   ├── latexRenderer.ts           # LaTeX渲染
│   ├── pdfGenerator.ts            # PDF生成
│   └── mediaRenderer.ts           # 多媒体渲染
└── types/
    └── lecture.ts                 # TypeScript类型定义
```

## 3. 现有资源利用

### 3.1 可复用的现有组件
- **LaTeX渲染器**：`@LaTeXRenderer.ts` - 用于数学公式渲染
- **题目组件**：`QuestionCard.tsx` - 用于题目显示
- **图片上传**：`ImageUpload.tsx` - 用于图片管理
- **模态框**：`RightSlideModal.tsx`, `ConfirmModal.tsx` - 用于弹窗

### 3.2 可复用的现有服务
- **题目服务**：`questionService.ts` - 获取题目数据
- **图片服务**：`imageService.ts` - 图片上传和管理
- **用户服务**：`userService.ts` - 用户权限验证

### 3.3 可复用的现有样式
- **A4纸张样式**：参考现有PDF预览样式
- **深色模式**：使用现有的dark模式类名
- **响应式布局**：使用现有的Tailwind响应式类

## 4. 开发文件准备

### 4.1 需要创建的新文件
```
frontend/src/
├── components/
│   └── lecture-editor/
│       ├── core/
│       │   ├── LectureEditor.tsx
│       │   ├── ContentRenderer.tsx
│       │   └── CursorManager.tsx
│       ├── components/
│       │   ├── QuestionInserter.tsx
│       │   ├── ImageManager.tsx
│       │   ├── Toolbar.tsx
│       │   └── PDFPreview.tsx
│       ├── hooks/
│       │   ├── useLectureEditor.ts
│       │   ├── useQuestionInsert.ts
│       │   └── usePDFExport.ts
│       └── utils/
│           ├── markdownParser.ts
│           ├── latexRenderer.ts
│           └── pdfGenerator.ts
├── pages/
│   └── lecture-editor/
│       ├── LectureEditorPage.tsx
│       └── index.tsx
└── types/
    └── lecture.ts
```

### 4.2 需要修改的现有文件
- **路由配置**：添加讲义编辑页面路由
- **侧边栏**：添加讲义编辑入口
- **权限管理**：添加讲义编辑权限

## 5. 核心功能实现（参考Vditor实现方案）

### 5.1 多模式编辑器（参考Vditor的三种模式）
- **WYSIWYG模式**：富文本编辑，所见即所得
- **即时渲染模式（IR）**：类似Typora，输入时实时渲染
- **分屏预览模式（SV）**：左侧编辑，右侧预览
- **模式切换**：用户可随时切换编辑模式
- **光标管理**：保持光标位置，支持编辑状态切换
- **语法高亮**：光标在元素内时显示原始语法

### 5.2 题目插入功能
- **拖拽插入**：从题目列表拖拽题目到编辑器
- **题目渲染**：在编辑器中显示题目内容
- **题目编辑**：支持在编辑器中直接编辑题目

### 5.3 LaTeX渲染（参考Vditor的mathRender）
- **实时渲染**：输入LaTeX语法时立即显示数学公式
- **错误处理**：LaTeX语法错误时显示原始文本
- **自动补全**：提供常用LaTeX命令补全
- **多行公式**：支持块级公式和行内公式
- **公式编辑**：点击公式可进入编辑模式

### 5.4 图片管理
- **图片上传**：支持拖拽上传图片
- **图片定位**：支持拖拽调整图片位置
- **图片大小**：支持调整图片尺寸

### 5.5 多媒体支持（参考Vditor的扩展功能）
- **流程图**：使用mermaid渲染流程图
- **时序图**：支持时序图绘制
- **甘特图**：支持项目甘特图
- **脑图**：支持思维导图
- **图表**：使用echarts渲染数据图表
- **五线谱**：支持音乐五线谱

### 5.6 PDF导出
- **样式一致**：导出PDF与编辑器显示效果一致
- **分页处理**：自动处理A4纸张分页
- **字体支持**：支持中文字体渲染
- **多媒体导出**：支持图表、公式等多媒体元素导出

## 6. 开发优先级（参考Vditor开发经验）

### 6.1 第一阶段：核心编辑器（参考Vditor的Vditor类）
1. 创建基础编辑器组件
2. 实现三种编辑模式（WYSIWYG/IR/SV）
3. 实现Markdown解析（集成Lute引擎）
4. 实现光标管理和位置保持
5. 实现模式切换功能

### 6.2 第二阶段：渲染引擎（参考Vditor的渲染模块）
1. 实现LaTeX渲染（mathRender）
2. 实现代码高亮（highlightRender）
3. 实现多媒体渲染（mermaidRender、chartRender等）
4. 实现图片渲染和懒加载

### 6.3 第三阶段：题目插入
1. 实现题目拖拽功能
2. 实现题目渲染
3. 实现题目编辑

### 6.4 第四阶段：工具栏和扩展（参考Vditor的toolbar模块）
1. 实现工具栏组件
2. 实现快捷键支持
3. 实现自定义工具栏配置

### 6.5 第五阶段：PDF导出
1. 实现PDF生成
2. 实现样式一致性
3. 实现分页处理
4. 实现多媒体导出

## 7. 技术难点与解决方案（参考Vditor解决方案）

### 7.1 光标管理（参考Vditor的cursor模块）
- **问题**：实时渲染时光标位置丢失
- **解决方案**：使用Range API和TreeWalker精确管理光标位置，参考Vditor的cursor.ts实现

### 7.2 内容同步（参考Vditor的preview模块）
- **问题**：编辑状态与渲染状态同步
- **解决方案**：使用debounce和状态管理确保内容一致性，参考Vditor的preview.ts实现

### 7.3 模式切换（参考Vditor的模式管理）
- **问题**：WYSIWYG/IR/SV模式间切换
- **解决方案**：参考Vditor的mode.ts实现，维护不同模式的状态

### 7.4 性能优化（参考Vditor的优化策略）
- **问题**：大量内容时渲染性能
- **解决方案**：虚拟滚动、懒加载、按需渲染，参考Vditor的lazyLoadImageRender

### 7.5 多媒体渲染（参考Vditor的渲染模块）
- **问题**：多种多媒体元素渲染
- **解决方案**：模块化渲染器，参考Vditor的mermaidRender、chartRender等

### 7.6 PDF导出
- **问题**：保持编辑器与PDF样式一致
- **解决方案**：使用相同的CSS样式和字体，参考Vditor的样式系统

## 8. 测试计划

### 8.1 功能测试
- 编辑器基本功能测试
- 题目插入功能测试
- 图片管理功能测试
- PDF导出功能测试

### 8.2 兼容性测试
- 不同浏览器兼容性
- 不同设备响应式测试
- 深色模式测试

### 8.3 性能测试
- 大量内容渲染性能
- 内存使用情况
- 导出PDF性能

## 9. 部署与维护

### 9.1 部署准备
- 确保所有依赖正确安装
- 配置环境变量
- 准备测试数据

### 9.2 维护计划
- 定期更新依赖
- 监控性能指标
- 收集用户反馈

## 10. Vditor集成方案

### 10.1 直接集成Vditor
- **优势**：功能完整，经过充分测试，社区活跃
- **劣势**：需要适配React，可能过于复杂
- **方案**：使用Vditor的React封装版本

### 10.2 参考Vditor实现
- **优势**：完全可控，可以定制化开发
- **劣势**：开发工作量大，需要解决各种技术难点
- **方案**：参考Vditor的架构和实现，使用相同的技术栈

### 10.3 混合方案（推荐）
- **核心编辑器**：参考Vditor的架构设计
- **渲染引擎**：直接使用Vditor的渲染模块
- **多媒体支持**：集成Vditor的多媒体渲染器
- **自定义功能**：题目插入、PDF导出等自定义开发

## 11. 总结

通过深入研究[Vditor项目](https://github.com/Vanessa219/vditor)，我们获得了宝贵的经验：

1. **架构设计**：Vditor的模块化架构为我们提供了清晰的开发思路
2. **技术选型**：Lute引擎、KaTeX、mermaid等技术栈经过验证
3. **功能实现**：三种编辑模式、光标管理、多媒体渲染等核心功能
4. **性能优化**：懒加载、按需渲染等优化策略
5. **用户体验**：丰富的工具栏、快捷键、主题支持等

讲义编辑功能可以借鉴Vditor的优秀设计，结合项目特定需求（题目插入、PDF导出），打造一个功能强大且用户友好的编辑器。重点是要保持代码的可维护性和用户体验的一致性。
