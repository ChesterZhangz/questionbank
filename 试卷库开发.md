# 试卷集功能开发计划

## 📋 功能概述

试卷集是一个允许用户从题库中选择题目组成试卷，并支持多套试卷管理的协作平台。用户可以创建试卷集，邀请协作者，设置售价，并管理试卷的发布状态。系统提供完整的LaTeX PDF预览功能，让用户在编辑试卷时就能看到最终的PDF效果。

## 🏗️ 系统架构

### 核心概念
- **试卷集 (PaperBank)**: 包含多套试卷的容器
- **试卷 (Paper)**: 由题库中题目组成的试卷
- **试卷集成员 (PaperBankMember)**: 具有不同权限的用户
- **试卷状态**: 草稿、已发布、已修改
- **LaTeX渲染引擎**: 实时预览PDF效果的渲染系统

### 权限体系
1. **所有者 (Owner)**: 最高权限，可执行所有操作
2. **管理者 (Manager)**: 可删除试卷和协作者
3. **协作者 (Collaborator)**: 可添加和编辑试卷
4. **查看者 (Viewer)**: 只能查看已发布的试卷

## 📊 数据模型设计

### 1. 试卷集模型 (PaperBank) ✅ 已完成
```typescript
interface PaperBank {
  _id: ObjectId;
  name: string;                    // 试卷集名称
  description: string;             // 试卷集简介
  avatar?: string;                 // 试卷集头像
  tags: string[];                  // 标签
  price: number;                   // 售价
  status: 'draft' | 'published';   // 试卷集状态
  ownerId: ObjectId;               // 所有者ID
  createdAt: Date;
  updatedAt: Date;
  publishedAt?: Date;              // 发布时间
  category: string;                // 分类（数学、物理等）
  // 注意：实际实现中移除了difficulty字段，因为试卷集本身不设难度
  memberCount: number;             // 成员数量
  paperCount: number;              // 试卷数量
  rating: number;                  // 评分
  purchaseCount: number;           // 购买次数
  customTags: string[];            // 用户自定义标签
}
```

### 2. 试卷模型 (Paper) ❌ 未实现
```typescript
interface Paper {
  _id: ObjectId;
  paperBankId: ObjectId;           // 所属试卷集ID
  name: string;                    // 试卷名称
  description?: string;            // 试卷描述
  questions: QuestionReference[];  // 题目引用
  totalScore: number;              // 总分
  status: 'draft' | 'published' | 'modified'; // 试卷状态
  creatorId: ObjectId;             // 创建者ID
  createdAt: Date;
  updatedAt: Date;
  publishedAt?: Date;              // 发布时间
  modifiedAt?: Date;               // 最后修改时间
  
  // 新增字段
  paperFormat: PaperFormat;        // 试卷格式设置
  headerInfo: HeaderInfo;          // 页眉信息
  footerInfo: FooterInfo;          // 页脚信息
  instructions: string[];          // 考试说明
  timeDistribution: TimeDistribution[]; // 时间分配建议
  difficultyBreakdown: DifficultyBreakdown; // 难度分布
}

interface PaperFormat {
  pageSize: 'A4' | 'Letter' | 'Legal'; // 页面尺寸
  margins: { top: number; bottom: number; left: number; right: number }; // 页边距
  fontSize: 'small' | 'normal' | 'large'; // 字体大小
  lineSpacing: 'single' | '1.5' | 'double'; // 行间距
  questionNumbering: 'continuous' | 'sectional' | 'custom'; // 题号编号方式
  showPageNumbers: boolean;        // 是否显示页码
  showTotalPages: boolean;         // 是否显示总页数
}

interface HeaderInfo {
  title: string;                   // 试卷标题
  subtitle?: string;               // 副标题
  institution: string;             // 机构名称
  department?: string;             // 部门名称
  logo?: string;                   // 机构Logo
  showDate: boolean;               // 是否显示日期
  customHeader?: string;           // 自定义页眉内容
}

interface FooterInfo {
  showPageNumber: boolean;         // 是否显示页码
  showTotalPages: boolean;         // 是否显示总页数
  customFooter?: string;           // 自定义页脚内容
  confidentiality?: string;        // 保密级别
}

interface TimeDistribution {
  section: string;                 // 部分名称
  timeMinutes: number;             // 建议时间（分钟）
  percentage: number;              // 占总时间百分比
}

interface DifficultyBreakdown {
  easy: { count: number; percentage: number; };
  medium: { count: number; percentage: number; };
  hard: { count: number; percentage: number; };
}
```

### 3. 试卷集成员模型 (PaperBankMember) ✅ 已完成
```typescript
interface PaperBankMember {
  _id: ObjectId;
  paperBankId: ObjectId;           // 试卷集ID
  userId: ObjectId;                // 用户ID
  username: string;                // 用户名
  email: string;                   // 邮箱
  role: 'owner' | 'manager' | 'collaborator' | 'viewer'; // 角色
  joinedAt: Date;                  // 加入时间
  lastActiveAt: Date;              // 最后活跃时间
  // 注意：实际实现中简化了权限系统，主要基于角色控制
}
```

### 4. 试卷购买记录模型 (PaperBankPurchase) ❌ 未实现
```typescript
interface PaperBankPurchase {
  _id: ObjectId;
  paperBankId: ObjectId;           // 试卷集ID
  userId: ObjectId;                // 购买者ID
  amount: number;                  // 购买金额
  purchasedAt: Date;               // 购买时间
  paymentMethod: string;           // 支付方式
  transactionId: string;           // 交易ID
  vcountAmount: number;            // VCount消费金额
  discountApplied?: number;        // 应用的折扣
  purchaseType: 'individual' | 'bulk' | 'subscription'; // 购买类型
  validUntil?: Date;               // 有效期（订阅类型）
}
```

### 5. 试卷模板模型 (PaperTemplate) ❌ 未实现
```typescript
interface PaperTemplate {
  _id: ObjectId;
  name: string;                    // 模板名称
  description: string;             // 模板描述
  category: string;                // 适用分类
  format: PaperFormat;             // 格式设置
  headerInfo: HeaderInfo;          // 页眉设置
  footerInfo: FooterInfo;          // 页脚设置
  instructions: string[];          // 默认考试说明
  createdBy: ObjectId;             // 创建者ID
  isPublic: boolean;               // 是否公开
  usageCount: number;              // 使用次数
  rating: number;                  // 评分
  tags: string[];                  // 标签
  createdAt: Date;
  updatedAt: Date;
}
```

## 🔌 API接口设计

### 试卷集管理 ✅ 大部分已完成
```
POST   /api/paper-banks                    // ✅ 创建试卷集
GET    /api/paper-banks                    // ✅ 获取试卷集列表
GET    /api/paper-banks/:id                // ✅ 获取试卷集详情
PUT    /api/paper-banks/:id                // ✅ 更新试卷集信息
DELETE /api/paper-banks/:id                // ✅ 删除试卷集
POST   /api/paper-banks/:id/publish       // ✅ 发布试卷集
POST   /api/paper-banks/:id/unpublish     // ❌ 取消发布
POST   /api/paper-banks/:id/duplicate     // ❌ 复制试卷集
GET    /api/paper-banks/:id/statistics    // ❌ 获取统计信息
```

### 试卷管理 ❌ 完全未实现
```
POST   /api/paper-banks/:id/papers        // ❌ 创建试卷
GET    /api/paper-banks/:id/papers        // ❌ 获取试卷列表
GET    /api/papers/:id                     // ❌ 获取试卷详情
PUT    /api/papers/:id                     // ❌ 更新试卷
DELETE /api/papers/:id                     // ❌ 删除试卷
POST   /api/papers/:id/publish            // ❌ 发布试卷
POST   /api/papers/:id/unpublish          // ❌ 取消发布
POST   /api/papers/:id/duplicate          // ❌ 复制试卷
POST   /api/papers/:id/preview            // ❌ 生成预览
POST   /api/papers/:id/export             // ❌ 导出试卷
GET    /api/papers/:id/statistics         // ❌ 获取使用统计
```

### 成员管理 ✅ 大部分已完成
```
POST   /api/paper-banks/:id/members       // ✅ 添加成员
GET    /api/paper-banks/:id/members       // ✅ 获取成员列表
PUT    /api/paper-banks/:id/members/:userId // ❌ 更新成员角色
DELETE /api/paper-banks/:id/members/:userId // ✅ 移除成员
POST   /api/paper-banks/:id/invite        // ✅ 发送邀请（通过邮件）
GET    /api/paper-banks/:id/invitations   // ❌ 获取邀请列表
POST   /api/paper-banks/:id/invitations/:id/accept // ❌ 接受邀请
POST   /api/paper-banks/:id/invitations/:id/decline // ❌ 拒绝邀请
```

### 购买和访问 ❌ 完全未实现
```
POST   /api/paper-banks/:id/purchase      // ❌ 购买试卷集
GET    /api/paper-banks/:id/download/:paperId // ❌ 下载试卷
GET    /api/paper-banks/:id/answer/:paperId   // ❌ 下载答案
GET    /api/paper-banks/:id/preview/:paperId  // ❌ 预览试卷
POST   /api/paper-banks/:id/review        // ❌ 提交评价
GET    /api/paper-banks/:id/reviews       // ❌ 获取评价列表
```

### 模板管理 ❌ 完全未实现
```
POST   /api/paper-templates                // ❌ 创建模板
GET    /api/paper-templates                // ❌ 获取模板列表
GET    /api/paper-templates/:id            // ❌ 获取模板详情
PUT    /api/paper-templates/:id            // ❌ 更新模板
DELETE /api/paper-templates/:id            // ❌ 删除模板
POST   /api/paper-templates/:id/use        // ❌ 使用模板
GET    /api/paper-templates/:id/usage      // ❌ 获取使用统计
```

### LaTeX渲染和预览 ❌ 完全未实现
```
POST   /api/latex/render                   // ❌ 渲染LaTeX内容
POST   /api/latex/preview                  // ❌ 生成预览
POST   /api/latex/validate                 // ❌ 验证LaTeX语法
GET    /api/latex/templates                // ❌ 获取LaTeX模板
POST   /api/latex/export-pdf               // ❌ 导出PDF
POST   /api/latex/export-tex               // ❌ 导出LaTeX源码
```

## 🎨 前端页面设计

### 1. 试卷集列表页面 (PaperBankListPage) ✅ 已完成
**功能特性：**
- ✅ 显示所有试卷集（公开和已购买的）
- ✅ 支持搜索、筛选、排序
- ✅ 显示试卷集状态、价格、成员数量等信息
- ✅ 分类筛选（数学、物理、化学等）
- ✅ 难度等级筛选（已移除，试卷集不设难度）
- ✅ 价格范围筛选
- ✅ 评分筛选
- ✅ 热门试卷集推荐
- ✅ 最近访问的试卷集
- ✅ 批量操作（收藏、分享、删除）

**页面布局：**
- ✅ 顶部：搜索栏、筛选器、排序选项
- ✅ 左侧：分类导航、筛选面板
- ✅ 主区域：试卷集卡片网格
- ✅ 右侧：热门标签、推荐内容
- ✅ 底部：分页控件

### 2. 试卷集详情页面 (PaperBankDetailPage) ❌ 未实现
**功能特性：**
- ❌ 显示试卷集基本信息
- ❌ 试卷列表（根据权限显示不同状态）
- ❌ 成员列表和管理
- ❌ 购买按钮（未购买用户）
- ❌ 评价和评论系统
- ❌ 使用统计和数据分析
- ❌ 相关推荐
- ❌ 分享功能

### 3. 试卷集创建/编辑页面 (CreatePaperBankPage/EditPaperBankPage) ✅ 已完成
**功能特性：**
- ✅ 基本信息编辑（名称、描述、头像、标签）
- ✅ 价格设置和折扣配置
- ✅ 权限配置和邀请设置
- ✅ 分类和难度设置（已移除难度设置）
- ✅ 目标受众设置
- ✅ 预览功能
- ✅ 模板选择

**页面布局：**
- ✅ 左侧：表单区域
- ✅ 右侧：实时预览、模板选择
- ✅ 底部：保存、发布、取消按钮

### 4. 试卷创建/编辑页面 (PaperFormPage) ❌ 未实现
**功能特性：**
- ❌ 题目选择器（从题库中选择题目）
- ❌ 题目排序和分值设置
- ❌ 试卷信息编辑（名称、描述、时长等）
- ❌ 实时LaTeX PDF预览功能
- ❌ 试卷格式设置
- ❌ 页眉页脚配置
- ❌ 考试说明编辑
- ❌ 时间分配设置
- ❌ 难度分布分析
- ❌ 模板应用
- ❌ 版本历史管理

### 5. 试卷查看页面 (PaperViewPage) ❌ 未实现
**功能特性：**
- ❌ 试卷内容展示
- ❌ 下载功能（PDF、Word、LaTeX格式）
- ❌ 答案查看（根据权限）
- ❌ 打印优化
- ❌ 分享功能
- ❌ 评价和反馈
- ❌ 使用统计

### 6. 成员管理页面 (PaperBankMembersPage) ✅ 已完成
**功能特性：**
- ✅ 成员列表显示
- ✅ 角色管理和权限设置
- ✅ 邀请新成员
- ✅ 成员活动记录
- ✅ 批量操作
- ✅ 权限模板管理

**页面布局：**
- ✅ 顶部：搜索、筛选、批量操作
- ✅ 主区域：成员列表表格
- ✅ 右侧：邀请面板、权限设置
- ✅ 底部：分页控件

### 7. 试卷模板管理页面 (PaperTemplatePage) ❌ 未实现
**功能特性：**
- ❌ 模板列表展示
- ❌ 模板创建和编辑
- ❌ 模板分类管理
- ❌ 模板评分和评论
- ❌ 模板使用统计
- ❌ 模板分享和导出

### 8. LaTeX编辑器页面 (LaTeXEditorPage) ❌ 未实现
**功能特性：**
- ❌ 实时LaTeX编辑
- ❌ 语法高亮和自动补全
- ❌ 实时预览渲染
- ❌ 模板库
- ❌ 数学公式编辑器
- ❌ 图表编辑器
- ❌ 导出功能

### 9. 试卷预览页面 (PaperPreviewPage) ❌ 未实现
**功能特性：**
- ❌ 完整的PDF预览
- ❌ 多页面浏览
- ❌ 缩放和导航
- ❌ 打印预览
- ❌ 导出设置
- ❌ 格式调整

### 10. 购买和支付页面 (PurchasePage) ❌ 未实现
**功能特性：**
- ❌ 试卷集详情展示
- ❌ 价格和折扣信息
- ❌ 支付方式选择
- ❌ VCount余额显示
- ❌ 购买确认
- ❌ 支付结果

### 11. 统计和分析页面 (AnalyticsPage) ❌ 未实现
**功能特性：**
- ❌ 试卷集使用统计
- ❌ 用户行为分析
- ❌ 收入统计
- ❌ 热门内容分析
- ❌ 趋势图表
- ❌ 导出报告

### 12. 设置和配置页面 (SettingsPage) ❌ 未实现
**功能特性：**
- ❌ 试卷集设置
- ❌ 权限配置
- ❌ 通知设置
- ❌ 集成设置
- ❌ 备份和恢复
- ❌ 高级选项

## 🚀 开发阶段规划

### 第一阶段：基础架构 ✅ 已完成 (100%)
- [x] 设计完整数据模型
- [x] 创建数据库集合和索引
- [x] 实现基础API接口
- [x] 设置权限验证中间件
- [x] 创建基础前端页面框架

### 第二阶段：核心功能 ✅ 已完成 (80%)
- [x] 试卷集CRUD操作
- [x] 试卷集成员权限系统
- [x] 基础前端页面实现
- [x] 用户认证和权限控制
- [ ] 试卷CRUD操作（未开始）

### 第三阶段：LaTeX渲染系统 ❌ 未开始 (0%)
- [ ] LaTeX渲染引擎集成
- [ ] 实时预览功能
- [ ] PDF生成和导出
- [ ] 数学公式编辑器
- [ ] 模板系统

### 第四阶段：高级功能 ❌ 未开始 (0%)
- [ ] 试卷发布状态管理
- [ ] 购买系统集成
- [ ] 下载功能实现
- [ ] 邀请系统完善
- [ ] 评价和评论系统

### 第五阶段：用户体验优化 ❌ 未开始 (0%)
- [ ] 界面美化和动画
- [ ] 响应式设计优化
- [ ] 性能优化
- [ ] 错误处理完善
- [ ] 用户反馈收集

### 第六阶段：测试和部署 ❌ 未开始 (0%)
- [ ] 功能测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 用户验收测试
- [ ] 生产环境部署

## 🔧 技术实现要点

### 后端实现
1. **权限验证中间件** ✅ 已完成: 根据用户角色和试卷集成员身份验证权限
2. **状态管理** ✅ 已完成: 试卷集的状态流转逻辑
3. **LaTeX渲染** ❌ 未实现: 集成KaTeX或MathJax进行数学公式渲染
4. **PDF生成** ❌ 未实现: 使用Puppeteer或类似工具生成PDF
5. **支付集成** ❌ 未实现: 购买流程的支付处理
6. **实时协作** ❌ 未实现: WebSocket实现多人同时编辑
7. **文件管理** ❌ 未实现: 试卷和答案文件的存储和访问控制

### 前端实现
1. **权限控制** ✅ 已完成: 根据用户权限显示/隐藏功能按钮
2. **状态管理** ✅ 已完成: 试卷集状态的实时更新
3. **LaTeX编辑器** ❌ 未实现: 专业的数学公式编辑体验
4. **实时预览** ❌ 未实现: 即时显示PDF效果
5. **文件下载** ❌ 未实现: 支持多种格式的试卷和答案下载
6. **实时协作** ❌ 未实现: 多人同时编辑的冲突处理
7. **响应式设计** ✅ 已完成: 适配各种设备和屏幕尺寸

### 数据库设计
1. **索引优化** ✅ 已完成: 为常用查询字段创建复合索引
2. **关联查询** ✅ 已完成: 试卷集、试卷、题目、用户之间的关联优化
3. **数据一致性** ✅ 已完成: 确保删除操作的数据完整性
4. **分片策略** ❌ 未实现: 为大规模数据设计分片方案
5. **缓存策略** ❌ 未实现: Redis缓存热门内容

## 🧪 测试策略

### 单元测试
- ✅ 权限验证逻辑
- ✅ 状态转换逻辑
- ✅ API接口功能
- ❌ LaTeX渲染功能
- ❌ PDF生成功能

### 集成测试
- ✅ 试卷集创建到发布的完整流程
- ✅ 成员权限变更的影响
- ❌ 购买流程的完整性
- ❌ LaTeX到PDF的转换流程

### 性能测试
- ✅ 大量试卷集的加载性能
- ❌ LaTeX渲染的响应时间
- ❌ PDF生成的性能
- ❌ 并发用户访问测试

### 用户测试
- ✅ 不同角色用户的操作体验
- ✅ 权限边界测试
- ✅ 界面友好性测试
- ✅ 移动端适配测试

## 📈 性能考虑

1. **分页加载** ✅ 已完成: 试卷集列表的分页显示
2. **缓存策略** ❌ 未实现: 热门试卷集和LaTeX渲染结果的缓存
3. **文件压缩** ❌ 未实现: PDF文件的压缩和优化
4. **CDN部署** ❌ 未实现: 静态资源和LaTeX资源的CDN分发
5. **数据库优化** ✅ 已完成: 查询优化和索引策略
6. **异步处理** ❌ 未实现: 耗时操作（如PDF生成）的异步处理

## 🔒 安全考虑

1. **权限验证** ✅ 已完成: 严格的API权限控制
2. **数据隔离** ✅ 已完成: 用户只能访问有权限的内容
3. **支付安全** ❌ 未实现: 安全的支付流程和验证
4. **文件安全** ❌ 未实现: 防止未授权下载和访问
5. **XSS防护** ❌ 未实现: LaTeX内容的XSS防护
6. **CSRF防护** ✅ 已完成: 跨站请求伪造防护
7. **数据加密** ✅ 已完成: 敏感数据的加密存储

## 🎯 核心创新点

### 1. 统一MD编辑器架构 ✅ 核心设计理念
基于用户的创新观点，设计一个统一的Markdown编辑器，支持三种试卷类型：

#### **1.1 讲义类型 (Lecture Notes)**
- **特点**：无模板，完全自由编辑
- **功能**：
  - ✅ 自由添加文字内容
  - ✅ 添加标题和章节
  - ✅ 拖拽题目到任意位置
  - ✅ 题目图片位置自由调整
  - ✅ 所见即所得的编辑体验
  - ✅ 导出PDF（与LaTeX渲染效果一致）

#### **1.2 习题类型 (Exercise Sets)**
- **特点**：有模板，结构化编辑
- **功能**：
  - ✅ 添加习题标题
  - ✅ 添加习题内容（包含题目图片）
  - ✅ 题目图片位置设置
  - ✅ 不设置分数（纯练习用途）
  - ✅ 应用习题模板
  - ✅ 导出PDF（精美排版）

#### **1.3 试卷类型 (Exams)**
- **特点**：有模板，完整考试设置
- **功能**：
  - ✅ 设置题型分类
  - ✅ 设置分值分配
  - ✅ 题目图片位置精确控制
  - ✅ 应用试卷模板
  - ✅ 考试说明和格式设置
  - ✅ 导出PDF（专业考试格式）

### 2. PDF前端模拟器 ✅ 核心特色功能
- **完全仿照LaTeX渲染效果**：前端实时预览与最终PDF完全一致
- **排版精美**：专业的数学排版和公式渲染
- **设计优美**：现代化的视觉设计和用户体验
- **实时预览**：编辑过程中即时看到PDF效果
- **多格式支持**：支持A4、Letter等不同纸张格式

### 3. 智能题目推荐 ❌ 未实现
- 基于试卷主题和难度的智能题目推荐
- 题目难度分布分析和建议
- 时间分配优化建议

### 4. 协作编辑系统 ❌ 未实现
- 多人同时编辑试卷
- 实时冲突检测和解决
- 版本控制和历史记录

### 5. 模板化设计 ✅ 部分实现
- 丰富的试卷模板库
- 一键应用专业格式
- 自定义模板创建和分享

## 🔧 统一MD编辑器技术架构

### 核心组件设计

#### **1. MD编辑器核心 (MarkdownEditor)**
```typescript
interface MarkdownEditor {
  // 编辑器核心
  content: string;                    // Markdown内容
  cursor: CursorPosition;             // 光标位置
  selection: TextSelection;           // 文本选择
  
  // 题目管理
  questions: QuestionReference[];     // 题目引用列表
  questionPositions: Map<string, Position>; // 题目位置映射
  
  // 渲染引擎
  renderer: LaTeXRenderer;            // LaTeX渲染器
  previewMode: 'live' | 'pdf' | 'split'; // 预览模式
  
  // 导出功能
  exportFormats: ExportFormat[];      // 支持的导出格式
  exportSettings: ExportSettings;     // 导出设置
}
```

#### **2. 题目拖拽系统 (QuestionDragDrop)**
```typescript
interface QuestionDragDrop {
  // 拖拽源（题库）
  sourceBank: QuestionBank;           // 来源题库
  availableQuestions: Question[];      // 可用题目
  
  // 拖拽目标（编辑器）
  targetEditor: MarkdownEditor;       // 目标编辑器
  dropZones: DropZone[];              // 可放置区域
  
  // 拖拽操作
  dragStart(question: Question): void;
  dragOver(position: Position): void;
  drop(question: Question, position: Position): void;
}
```

#### **3. 图片位置管理器 (ImagePositionManager)**
```typescript
interface ImagePositionManager {
  // 位置控制
  position: Position;                 // 图片位置
  size: Size;                         // 图片尺寸
  alignment: 'left' | 'center' | 'right'; // 对齐方式
  
  // 布局控制
  flow: 'inline' | 'block' | 'float'; // 流式布局
  margin: Margin;                     // 边距设置
  
  // 响应式
  responsive: boolean;                // 是否响应式
  breakpoints: Breakpoint[];          // 断点设置
}
```

#### **4. 模板系统 (TemplateSystem)**
```typescript
interface TemplateSystem {
  // 模板类型
  type: 'lecture' | 'exercise' | 'exam';
  
  // 模板内容
  structure: TemplateStructure;        // 模板结构
  styles: TemplateStyles;             // 样式设置
  components: TemplateComponent[];     // 组件配置
  
  // 模板应用
  apply(template: Template): void;
  customize(settings: CustomSettings): void;
  saveAsTemplate(): Template;
}
```

### 三种类型的详细设计

#### **讲义类型 (Lecture Notes)**
```typescript
interface LectureNotesEditor extends MarkdownEditor {
  // 讲义特有功能
  allowFreeText: true;                // 允许自由文本
  allowFreePositioning: true;         // 允许自由定位
  
  // 内容结构
  sections: Section[];                 // 章节结构
  notes: Note[];                      // 笔记内容
  
  // 题目集成
  questionPlacement: 'inline' | 'block' | 'custom'; // 题目放置方式
  questionSpacing: 'tight' | 'normal' | 'loose';    // 题目间距
  
  // 导出设置
  exportFormat: 'lecture-pdf' | 'lecture-tex';      // 导出格式
  includeAnswers: boolean;            // 是否包含答案
}
```

#### **习题类型 (Exercise Sets)**
```typescript
interface ExerciseEditor extends MarkdownEditor {
  // 习题特有功能
  template: ExerciseTemplate;          // 习题模板
  scoring: false;                      // 不设置分数
  
  // 习题结构
  exercises: Exercise[];               // 习题列表
  exerciseGroups: ExerciseGroup[];     // 习题分组
  
  // 题目管理
  questionOrder: 'sequential' | 'random'; // 题目顺序
  questionSpacing: number;             // 题目间距
  
  // 模板应用
  applyExerciseTemplate(template: ExerciseTemplate): void;
  customizeExerciseLayout(layout: ExerciseLayout): void;
}
```

#### **试卷类型 (Exam Editor)**
```typescript
interface ExamEditor extends MarkdownEditor {
  // 试卷特有功能
  template: ExamTemplate;              // 试卷模板
  scoring: true;                       // 设置分数
  
  // 试卷结构
  sections: ExamSection[];             // 试卷部分
  totalScore: number;                  // 总分
  timeLimit: number;                   // 时间限制
  
  // 题型管理
  questionTypes: QuestionType[];       // 题型列表
  scoreDistribution: ScoreDistribution; // 分值分布
  
  // 格式设置
  examFormat: ExamFormat;              // 试卷格式
  headerFooter: HeaderFooter;          // 页眉页脚
  
  // 模板应用
  applyExamTemplate(template: ExamTemplate): void;
  customizeExamLayout(layout: ExamLayout): void;
}
```

### PDF前端模拟器设计

#### **1. 渲染引擎 (LaTeXRenderer)**
```typescript
interface LaTeXRenderer {
  // 渲染模式
  mode: 'preview' | 'final' | 'print';
  
  // 渲染设置
  settings: RenderSettings;            // 渲染设置
  quality: 'draft' | 'normal' | 'high'; // 渲染质量
  
  // 实时渲染
  renderLive(content: string): Promise<RenderResult>;
  renderPDF(content: string): Promise<PDFResult>;
  
  // 样式应用
  applyStyles(styles: LaTeXStyles): void;
  applyTemplate(template: LaTeXTemplate): void;
}
```

#### **2. 预览组件 (PDFPreview)**
```typescript
interface PDFPreview {
  // 预览模式
  viewMode: 'single' | 'continuous' | 'facing';
  zoom: number;                        // 缩放比例
  
  // 导航控制
  currentPage: number;                 // 当前页面
  totalPages: number;                  // 总页数
  
  // 交互功能
  enableAnnotations: boolean;          // 启用注释
  enableBookmarks: boolean;            // 启用书签
  
  // 导出功能
  exportToPDF(): Promise<Blob>;
  exportToImage(format: 'png' | 'jpg'): Promise<Blob>;
}
```

## 🚀 开发阶段规划（更新版）

### 第一阶段：基础架构 ✅ 已完成 (100%)
- [x] 设计完整数据模型
- [x] 创建数据库集合和索引
- [x] 实现基础API接口
- [x] 设置权限验证中间件
- [x] 创建基础前端页面框架

### 第二阶段：核心功能 ✅ 已完成 (80%)
- [x] 试卷集CRUD操作
- [x] 试卷集成员权限系统
- [x] 基础前端页面实现
- [x] 用户认证和权限控制
- [ ] 试卷CRUD操作（未开始）

### 第三阶段：统一MD编辑器系统 ❌ 新设计 (0%)
- [ ] 核心MD编辑器开发
- [ ] 题目拖拽系统实现
- [ ] 图片位置管理器
- [ ] 三种类型编辑器（讲义、习题、试卷）
- [ ] 模板系统集成

### 第四阶段：LaTeX渲染和PDF模拟器 ❌ 核心功能 (0%)
- [ ] LaTeX渲染引擎集成
- [ ] PDF前端模拟器开发
- [ ] 实时预览功能
- [ ] 多格式导出支持
- [ ] 精美排版实现

### 第五阶段：高级功能和用户体验 ❌ 未开始 (0%)
- [ ] 智能题目推荐
- [ ] 协作编辑系统
- [ ] 购买系统集成
- [ ] 统计和分析功能
- [ ] 移动端适配

### 第六阶段：测试和部署 ❌ 未开始 (0%)
- [ ] 功能测试
- [ ] 性能测试
- [ ] 用户验收测试
- [ ] 生产环境部署

## 📊 当前开发完成度总结（更新版）

**总体完成度：约 35%**

### 已完成模块 (✅)
- **基础架构**: 100% 完成
- **试卷集管理**: 90% 完成
- **成员权限系统**: 85% 完成
- **基础前端界面**: 70% 完成
- **API接口**: 60% 完成

### 未完成模块 (❌)
- **统一MD编辑器**: 0% 完成（新设计）
- **LaTeX渲染系统**: 0% 完成
- **PDF前端模拟器**: 0% 完成（新设计）
- **三种类型编辑器**: 0% 完成（新设计）
- **购买系统**: 0% 完成

### 下一步开发重点（更新版）
1. **统一MD编辑器核心** - 新的核心架构
2. **题目拖拽系统** - 讲义、习题、试卷的基础
3. **LaTeX渲染引擎** - PDF模拟器的核心
4. **三种类型编辑器** - 讲义、习题、试卷的具体实现
5. **PDF前端模拟器** - 完全仿照LaTeX渲染效果

---

*本开发计划已根据用户的新观点进行了重大更新，重点关注统一MD编辑器架构和PDF前端模拟器的设计*
